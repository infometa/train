# DeepFilterGAN 音色修复模型配置
# 基于 Stochastic Regeneration 框架
# 
# 核心改进：
# 1. 残差学习设计：模型学习 (clean - degraded) 的差异
# 2. 高频加权 STFT Loss：强调高频恢复
# 3. 调整损失权重：降低 L1，提高 STFT

# 数据配置
data:
  # 干净语音数据集路径
  vctk_path: "/data/audio/vctk/wav48_silence_trimmed"
  aishell3_path: "/data/audio/Aishell3/train/wav"
  
  # 退化配置
  ir_path: "/data/audio/impulse_responses/SLR26/simulated_rirs_48k"
  noise_path: "/data/audio/freesound/datasets_fullband/noise_fullband"
  
  # 输出路径
  output_dir: "/data/train_data_lite"
  
  # 采样率
  sample_rate: 48000
  
  # 训练数据配置
  segment_length: 48000  # 1秒（训练裁剪长度）
  save_segment_length: 48000  # 保存 1秒片段，避免丢弃短音频，提升样本量
  segment_hop: 24000     # 生成阶段多片段切分步长（0.5秒）
  snr_range: [5, 30]     # 信噪比范围 (dB)，覆盖低 SNR
  noise_prob: 0.9        # 加噪概率，保留少量纯净样本
  ir_prob: 0.7           # 添加混响的概率
  
  # 数据集比例
  dataset_ratio:
    vctk: 0.3            # 英文
    aishell3: 0.7        # 中文
  
  # 数据划分
  val_ratio: 0.05

  # DF 引入的潜在延迟对齐（样本级，全局估计）
  align_df_delay: true
  align_max_shift: 2000     # 最大估计偏移（样本），约 42ms，覆盖更多 DF 场景差异
  align_sample_count: 32    # 估计偏移时采样的样本对数量
  
  # DataLoader
  num_workers: 0            # 避免 shm/文件系统共享问题，单进程加载

# 模型配置
model:
  name: "CausalUNetGAN"
  
  # Generator (U-Net)
  generator:
    in_channels: 1
    out_channels: 1
    channels: [64, 128, 256, 512]
    kernel_size: 7
    bottleneck_type: "gru"  # gru / lstm / none
    bottleneck_layers: 2
    use_weight_norm: true
    
  # Discriminator (Multi-Scale)
  discriminator:
    scales: 3
    channels: [64, 128, 256, 512, 1024]
    kernel_size: 5
    use_spectral_norm: true

# 训练配置
training:
  batch_size: 16
  epochs: 60
  
  # 优化器
  optimizer:
    type: "AdamW"
    lr_g: 1.0e-4
    lr_d: 1.0e-4
    betas: [0.8, 0.99]
    weight_decay: 0.01
  
  # 学习率调度
  scheduler:
    type: "CosineAnnealingLR"
    T_max: 60            # 等于 epochs
    eta_min: 1.0e-6
    warmup_epochs: 5     # 延长预热，提升稳定性
  
  # ========== 核心修改：损失权重 ==========
  loss_weights:
    l1: 5.0              # 降低时域权重
    multi_stft: 5.0      # 提升频域权重
    adversarial: 0.5     # 适当减弱 GAN
    feature_matching: 1.5 # 减弱 FM 稳定收敛
  # ========================================
  
  # Multi-Resolution STFT Loss（带高频加权）
  stft_config:
    fft_sizes: [512, 1024, 2048]
    hop_sizes: [128, 256, 512]
    win_lengths: [512, 1024, 2048]
    sample_rate: 48000
    hf_weight: 2.0       # 高频加权倍数
    hf_cutoff: 3000      # 高频起始频率 (Hz)
  
  # 训练策略
  gan_start_epoch: 15     # 先让重构收敛，再启用 GAN
  grad_clip: 0.5
  
  # 检查点
  save_every: 3
  log_every: 400

# 推理配置
inference:
  # ONNX 导出
  onnx_opset: 17
  simplify: true
  
  # 实时推理
  frame_size: 480  # 10ms @ 48kHz
  lookahead: 0     # 因果，无前瞻

# 分布式训练
distributed:
  enabled: true
  backend: "nccl"

# 日志
logging:
  tensorboard: true
  wandb: false
  project_name: "timbre_restore"
