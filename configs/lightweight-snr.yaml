# ===========================================
# 轻量化均衡版配置 (Lightweight Plus / Balanced)
# 目标: 兼顾实时性 (RTF < 0.8) 与高音质
# 改进: 相比 Lite 版增加了通道和层数，大幅提升高频还原能力
# ===========================================

data:
  # 路径配置
  vctk_path: "/data/audio/vctk/wav48_silence_trimmed"
  aishell3_path: "/data/audio/Aishell3/train/wav"
  ir_path: "/data/audio/impulse_responses/SLR26/simulated_rirs_48k"
  noise_path: "/data/audio/freesound/datasets_fullband/noise_fullband"
  
  # === 使用 SNR 过滤后的数据集 ===
  output_dir: "/data/train_data_snr"

  sample_rate: 48000
  segment_length: 24000       # 0.5 秒训练段
  save_segment_length: 48000  # 保存 1 秒
  segment_hop: 24000
  
  # === 高质量修复策略 ===
  snr_range: [15, 30]     # 提升下限，聚焦中高 SNR 场景
  noise_prob: 0.8         # 提高纯净样本占比，强化恒等映射
  ir_prob: 0.4            # 略降混响比例，减少过度去混响风险

  dataset_ratio:
    vctk: 0.3
    aishell3: 0.7

  val_ratio: 0.05
  
  # === 必须关闭二次对齐 (数据已物理对齐) ===
  align_df_delay: false
  align_max_shift: 4000
  align_sample_count: 32
  
  # === 高性能加载 ===
  num_workers: 8

model:
  name: "CausalUNetGAN_Balanced"
  
  # Generator (U-Net) - 均衡增强版
  generator:
    in_channels: 1
    out_channels: 1
    # [升级 1] 通道扩容: 32 -> 48 (增加 50% 容量，提升细节记忆)
    channels: [48, 96, 192, 384]
    # [升级 2] 恢复大卷积: 5 -> 7 (提升感受野，改善低频连贯性)
    kernel_size: 7
    bottleneck_type: "gru"
    # [升级 3] 恢复双层 GRU: 1 -> 2 (消除时序涂抹感)
    bottleneck_layers: 2
    use_weight_norm: true
    
  # Discriminator (Multi-Scale) - 配套增强
  discriminator:
    scales: 2
    # [升级] 判别器通道对应增加，保持对抗强度
    channels: [48, 96, 192, 384, 768]
    kernel_size: 5
    use_spectral_norm: true

training:
  # [调整] 模型变大，Batch Size 微调以防爆显存 (32 -> 24)
  batch_size: 24
  epochs: 90
  
  # 优化器 (保持防崩盘设置)
  optimizer:
    type: "AdamW"
    lr_g: 5.0e-5       # 低学习率求稳
    lr_d: 5.0e-5
    betas: [0.8, 0.99]
    weight_decay: 0.01
  
  scheduler:
    type: "CosineAnnealingLR"
    T_max: 90
    eta_min: 1.0e-6
    warmup_epochs: 8
  
  loss_weights:
    l1: 3.0
    multi_stft: 3.0
    adversarial: 1.0
    feature_matching: 2.0
  
  stft_config:
    fft_sizes: [512, 1024, 2048]
    hop_sizes: [128, 256, 512]
    win_lengths: [512, 1024, 2048]
    sample_rate: 48000
    # 高频权重：适度降低以提升稳定性，避免振铃
    hf_weight: 3.0
    hf_cutoff: 3000
  
  # 策略
  gan_start_epoch: 10
  # [关键] 强力梯度裁剪，防止 NaN
  grad_clip: 0.1
  
  save_every: 5
  log_every: 500

inference:
  onnx_opset: 17
  simplify: true
  frame_size: 480
  lookahead: 0

distributed:
  enabled: true
  backend: "nccl"

logging:
  tensorboard: true
  wandb: false
  project_name: "timbre_restore_balanced"
