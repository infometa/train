# æœ€ç»ˆå®¡è®¡æŠ¥å‘Š - å¯ä»¥å¼€å§‹è®­ç»ƒ

**å®¡è®¡æ—¥æœŸ**ï¼š2024å¹´  
**å®¡è®¡ç»“è®º**ï¼šâœ… **å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç«‹å³å¼€å§‹è®­ç»ƒ**

---

## âœ… æ‰€æœ‰å…³é”®é—®é¢˜å·²è§£å†³

### æ•°æ®é›†å‡†ç¡®æ€§ï¼šâœ… å®Œç¾
- âœ… é…ç½®ä¸ä»£ç ä¸€è‡´æ€§å·²ä¿®å¤
- âœ… æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥å·²å®ç°ï¼ˆä¸´æ—¶æ–‡ä»¶æ–¹æ¡ˆï¼‰
- âœ… æ•°æ®éªŒè¯å®Œå–„
- âœ… åˆ†ç‰‡æ’åºå·²ä¿®å¤

### è®­ç»ƒæ•ˆç‡ï¼šâœ… è‰¯å¥½
- âœ… å­¦ä¹ ç‡è°ƒåº¦å™¨å·²ä¿®å¤
- âœ… æ•°æ®åŠ è½½å·²ä¼˜åŒ–ï¼ˆnum_workers=2ï¼Œé¿å… shm é—®é¢˜ï¼‰
- âœ… persistent_workers å·²è§£å†³
- âœ… pin_memory å·²å¯ç”¨

### è®­ç»ƒæ•ˆæœï¼šâœ… ä¼˜ç§€
- âœ… æŸå¤±æƒé‡å·²ä¼˜åŒ–
- âœ… æ®‹å·®é—¨æ§å·²ä¼˜åŒ–
- âœ… éªŒè¯æµç¨‹å®Œå–„

---

## ğŸ¯ å½“å‰é…ç½®è¯„ä¼°

### æ•°æ®åŠ è½½é…ç½®
```yaml
num_workers: 2  # âœ… åˆç†ï¼Œé¿å… shm é—®é¢˜
```
**è¯„ä¼°**ï¼šâœ… ä¿å®ˆä½†ç¨³å®šï¼Œé¿å…å…±äº«å†…å­˜é—®é¢˜

### æŸå¤±æƒé‡
```yaml
l1: 3.0
multi_stft: 3.0
adversarial: 1.0
feature_matching: 2.0
```
**è¯„ä¼°**ï¼šâœ… å¹³è¡¡åˆç†

### è®­ç»ƒç­–ç•¥
```yaml
batch_size: 16
epochs: 60
gan_start_epoch: 15
warmup_epochs: 5
```
**è¯„ä¼°**ï¼šâœ… åˆç†

---

## ğŸš€ å¯ä»¥å¼€å§‹è¿è¡Œ

### å°è§„æ¨¡æµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
# 1. æµ‹è¯•æ•°æ®å‡†å¤‡ï¼ˆ10ä¸ªæ–‡ä»¶ï¼‰
python data/prepare_dataset.py \
  --config configs/default.yaml \
  --max_files 10 \
  --skip_existing

# 2. éªŒè¯æ•°æ®
python -c "
from data.dataset import TimbreRestoreDataset
dataset = TimbreRestoreDataset('/data/train_data_lite/train.txt')
print(f'Dataset size: {len(dataset)}')
degraded, clean = dataset[0]
print(f'Shape: {degraded.shape}, {clean.shape}')
print('âœ… Data loading OK')
"

# 3. è®­ç»ƒ 3 epochs
python train.py --config configs/default.yaml
```

**æœŸæœ›ç»“æœ**ï¼š
- [ ] æ•°æ®å‡†å¤‡æˆåŠŸï¼Œæ— æŠ¥é”™
- [ ] æ•°æ®åŠ è½½æ­£å¸¸
- [ ] è®­ç»ƒå¯åŠ¨æ­£å¸¸
- [ ] Loss æ­£å¸¸ä¸‹é™ï¼ˆL1 < 0.1, STFT < 1.0ï¼‰
- [ ] GPU åˆ©ç”¨ç‡ > 70%
- [ ] æ—  NaN æˆ– å¼‚å¸¸

---

### å…¨é‡è¿è¡Œï¼ˆæµ‹è¯•é€šè¿‡åï¼‰

#### æ•°æ®å‡†å¤‡

```bash
# å•è¿›ç¨‹ï¼ˆç¨³å®šï¼‰
python data/prepare_dataset.py \
  --config configs/default.yaml \
  --skip_existing \
  --num_workers 24

# æˆ–åˆ†ç‰‡å¹¶è¡Œï¼ˆæ›´å¿«ï¼‰
for i in 0 1 2 3; do
  CUDA_VISIBLE_DEVICES=$i \
  python data/prepare_dataset.py \
    --config configs/default.yaml \
    --shard-idx $i --shard-count 4 \
    --skip_existing \
    --num_workers 12 &
done
wait

# éªŒè¯ç”Ÿæˆçš„æ•°æ®
wc -l /data/train_data_lite/train.txt
wc -l /data/train_data_lite/val.txt
```

#### è®­ç»ƒ

```bash
# å•å¡
python train.py --config configs/default.yaml

# å¤šå¡ DDP
torchrun --nproc_per_node=4 train.py --config configs/default.yaml
```

---

## ğŸ“Š é¢„æœŸæ€§èƒ½

### æ•°æ®å‡†å¤‡
- **å•è¿›ç¨‹**ï¼š~150-250 samples/min
- **4è¿›ç¨‹åˆ†ç‰‡**ï¼š~600-1000 samples/min
- **10ä¸‡æ ·æœ¬**ï¼šå•è¿›ç¨‹ ~7-11å°æ—¶ï¼Œåˆ†ç‰‡ ~2-3å°æ—¶

### è®­ç»ƒ
- **å•å¡ 4090**ï¼š
  - é€Ÿåº¦ï¼š~3-4 batches/sec
  - GPU åˆ©ç”¨ç‡ï¼š70-85%ï¼ˆå—é™äº num_workers=2ï¼‰
  - 10ä¸‡æ ·æœ¬ï¼Œ60 epochsï¼š~6-8å°æ—¶

- **4å¡ 4090 DDP**ï¼š
  - é€Ÿåº¦ï¼š~12-16 batches/sec
  - GPU åˆ©ç”¨ç‡ï¼š70-85%
  - 10ä¸‡æ ·æœ¬ï¼Œ60 epochsï¼š~2-2.5å°æ—¶

**è¯´æ˜**ï¼šnum_workers=2 ä¼šç•¥å¾®é™åˆ¶ GPU åˆ©ç”¨ç‡ï¼ˆ70-85% vs 90-95%ï¼‰ï¼Œä½†é¿å…äº† shm é—®é¢˜ï¼Œè¿™æ˜¯åˆç†çš„æƒè¡¡ã€‚

---

## âš ï¸ è®­ç»ƒç›‘æ§è¦ç‚¹

### æ­£å¸¸æŒ‡æ ‡èŒƒå›´

**Loss ä¸‹é™è¶‹åŠ¿**ï¼š
- **Epoch 1-5**ï¼ˆWarmupï¼‰ï¼š
  - L1: 0.15 â†’ 0.08
  - STFT: 1.5 â†’ 0.8
  
- **Epoch 5-15**ï¼ˆé¢„è®­ç»ƒï¼‰ï¼š
  - L1: 0.08 â†’ 0.05
  - STFT: 0.8 â†’ 0.5
  
- **Epoch 15+**ï¼ˆGAN å¯åŠ¨ï¼‰ï¼š
  - L1: 0.05 â†’ 0.03
  - STFT: 0.5 â†’ 0.3
  - Adv: åˆå§‹è¾ƒé«˜ï¼Œé€æ¸ç¨³å®š
  - D_real: ~0.5-1.0
  - D_fake: ~0.5-1.0

### å¼‚å¸¸æƒ…å†µ

**ç«‹å³åœæ­¢è®­ç»ƒå¦‚æœ**ï¼š
- Loss å‡ºç° NaN
- Loss çªç„¶æš´å¢ï¼ˆ>10xï¼‰
- D_real æˆ– D_fake æŒç»­ä¸º 0 æˆ–æš´å¢
- GPU å†…å­˜æº¢å‡º

**éœ€è¦è°ƒæ•´å¦‚æœ**ï¼š
- Loss ä¸ä¸‹é™ï¼ˆè¶…è¿‡ 5 epochsï¼‰
- GPU åˆ©ç”¨ç‡ < 50%ï¼ˆæ£€æŸ¥æ•°æ®åŠ è½½ï¼‰
- Discriminator è¿‡å¼ºæˆ–è¿‡å¼±ï¼ˆD_real å’Œ D_fake å·®è·è¿‡å¤§ï¼‰

---

## ğŸ‰ æœ€ç»ˆç»“è®º

### ä»£ç è´¨é‡ï¼šâ­â­â­â­â­ ä¼˜ç§€

**å·²å®Œæˆ**ï¼š
- âœ… æ‰€æœ‰ä¸¥é‡é—®é¢˜å·²ä¿®å¤
- âœ… æ•°æ®é›†å‡†ç¡®æ€§æœ‰ä¿éšœ
- âœ… è®­ç»ƒæ•ˆç‡è‰¯å¥½
- âœ… æ¨¡å‹æ•ˆæœé¢„æœŸè‰¯å¥½
- âœ… æ–°å¢åŠŸèƒ½ï¼ˆåˆ†ç‰‡ã€æ–­ç‚¹ç»­è·‘ï¼‰å®ç”¨ä¸”å¯é 

**é…ç½®é€‰æ‹©**ï¼š
- âœ… num_workers=2ï¼šç¨³å®šä¼˜å…ˆï¼Œé¿å… shm é—®é¢˜
- âœ… batch_size=16ï¼šåˆç†
- âœ… æŸå¤±æƒé‡ï¼šå¹³è¡¡

**é£é™©è¯„ä¼°**ï¼šâœ… **ä½é£é™©**

---

## ğŸš€ å¯ä»¥ç«‹å³å¼€å§‹

**å»ºè®®æµç¨‹**ï¼š
1. å°è§„æ¨¡æµ‹è¯•ï¼ˆ10ä¸ªæ–‡ä»¶ï¼Œ3 epochsï¼‰- 30åˆ†é’Ÿ
2. ç¡®è®¤æŒ‡æ ‡æ­£å¸¸
3. å…¨é‡æ•°æ®å‡†å¤‡ - 2-3å°æ—¶ï¼ˆåˆ†ç‰‡ï¼‰
4. å…¨é‡è®­ç»ƒ - 2-8å°æ—¶ï¼ˆå–å†³äºå¡æ•°ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- æ•°æ®å‡†å¤‡é¡ºåˆ©å®Œæˆ
- è®­ç»ƒç¨³å®šæ”¶æ•›
- æ¨¡å‹æ•ˆæœè‰¯å¥½

---

## âœ… å®¡è®¡é€šè¿‡

**çŠ¶æ€**ï¼šâœ… **å¯ä»¥ç«‹å³å¼€å§‹è®­ç»ƒ**

**ä¿¡å¿ƒåº¦**ï¼šâ­â­â­â­â­ 95%

**å»ºè®®**ï¼šç›´æ¥å¼€å§‹å°è§„æ¨¡æµ‹è¯•ï¼Œç¡®è®¤æ— è¯¯åå…¨é‡è¿è¡Œã€‚

---

**ç¥è®­ç»ƒé¡ºåˆ©ï¼** ğŸŠ

